/*! @name videojs-contrib-ads @version 7.4.0 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js"),require("global/window"),require("global/document")):"function"==typeof define&&define.amd?define(["video.js","global/window","global/document"],t):(e=e||self).videojsContribAds=t(e.videojs,e.window,e.document)}(this,function(e,t,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n;var a="7.4.0";var r=function(e,t){t.isImmediatePropagationStopped=function(){return!0},t.cancelBubble=!0,t.isPropagationStopped=function(){return!0}},o=function(e,t,n){r(0,n),e.trigger({type:t+n.type,originalEvent:n})},i=function(e,t){e.ads.isInAdMode()&&(e.ads.isContentResuming()?e.ads._contentEnding&&o(e,"content",t):o(e,"ad",t))},s=function(e,t){e.ads.isInAdMode()?e.ads.isContentResuming()?(r(0,t),e.trigger("resumeended")):o(e,"ad",t):e.ads._contentHasEnded||e.ads.stitchedAds()||(o(e,"content",t),e.trigger("readyforpostroll"))},d=function(e,t){if(!("loadstart"===t.type&&!e.ads._hasThereBeenALoadStartDuringPlayerLife||"loadeddata"===t.type&&!e.ads._hasThereBeenALoadedData||"loadedmetadata"===t.type&&!e.ads._hasThereBeenALoadedMetaData))if(e.ads.inAdBreak())o(e,"ad",t);else{if(e.currentSrc()!==e.ads.contentSrc)return;o(e,"content",t)}},l=function(e,t){e.ads.inAdBreak()?o(e,"ad",t):e.ads.isContentResuming()&&o(e,"content",t)};function u(e){"playing"===e.type?i(this,e):"ended"===e.type?s(this,e):"loadstart"===e.type||"loadeddata"===e.type||"loadedmetadata"===e.type?d(this,e):"play"===e.type?l(this,e):this.ads.isInAdMode()&&(this.ads.isContentResuming()?o(this,"content",e):o(this,"ad",e))}function c(){return(c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}function p(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,f(e,t)}function f(e,t){return(f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var h={},g=function(){!function(n){if(e.dom.isInFrame()&&"function"!=typeof t.__tcfapi){for(var a,r=t,o={};r;){try{if(r.frames.__tcfapiLocator){a=r;break}}catch(e){}if(r===t.top)break;r=r.parent}if(!a)return;t.__tcfapi=function(e,t,n,r){var i=Math.random()+"",s={__tcfapiCall:{command:e,parameter:r,version:t,callId:i}};o[i]=n,a.postMessage(s,"*")},t.addEventListener("message",function(e){var t={};try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch(e){}var n=t.__tcfapiReturn;n&&"function"==typeof o[n.callId]&&(o[n.callId](n.returnValue,n.success),o[n.callId]=null)},!1)}}(),"function"==typeof t.__tcfapi&&t.__tcfapi("addEventListener",2,function(e,t){t&&(h=e)})},y="",v=function(e,n){if(void 0===n&&(n=t),n.__uspapi)n.__uspapi("getUSPData",1,function(t,n){var a=n?t.uspString:null;y=a,e(a)});else{var a=function(e){for(var t=e.parent;t!==e.top;){try{if(t.frames&&t.frames.__uspapiLocator)return t}catch(e){}t=t.parent}try{if(e.top.frames&&e.top.frames.__uspapiLocator)return e.top}catch(e){}return null}(n);if(!a)return void e(null);var r=Math.random().toString(36).substring(2),o={__uspapiCall:{command:"getUSPData",version:1,callId:r}};n.addEventListener("message",function t(a){if(a&&a.data&&a.data.__uspapiReturn&&a.data.__uspapiReturn.callId===r){n.removeEventListener("message",t,!1);var o=a.data.__uspapiReturn,i=o.returnValue,s=o.success?i.uspString:null;y=s,e(s)}},!1),a.postMessage(o,"*")}},m=function(e,t){return t?encodeURIComponent(e):e},A=function(e,t){var n={};return["description","tags","reference_id","ad_keys"].forEach(function(a){e&&e[a]?n["{mediainfo."+a+"}"]=e[a]:t["{mediainfo."+a+"}"]?n["{mediainfo."+a+"}"]=t["{mediainfo."+a+"}"]:n["{mediainfo."+a+"}"]=""}),["custom_fields","customFields"].forEach(function(t){!function(e,t,n){if(e&&e[n])for(var a=e[n],r=Object.keys(a),o=0;o<r.length;o++)t["{mediainfo."+n+"."+r[o]+"}"]=a[r[o]]}(e,n,t)}),n},_=function(e){var t={},n=e.replace(/{([^}=]+)=([^}]*)}/g,function(e,n,a){return t["{"+n+"}"]=a,"{"+n+"}"});return{defaults:t,modifiedString:n}},S=function(a){return{"{player.id}":a.options_["data-player"]||a.id_,"{player.height}":a.currentHeight(),"{player.width}":a.currentWidth(),"{player.heightInt}":Math.round(a.currentHeight()),"{player.widthInt}":Math.round(a.currentWidth()),"{player.autoplay}":a.autoplay()?1:0,"{player.muted}":a.muted()?1:0,"{player.language}":a.language()||"","{mediainfo.id}":a.mediainfo?a.mediainfo.id:"","{mediainfo.name}":a.mediainfo?a.mediainfo.name:"","{mediainfo.duration}":a.mediainfo?a.mediainfo.duration:"","{player.duration}":a.duration(),"{player.durationInt}":Math.round(a.duration()),"{player.live}":a.duration()===1/0?1:0,"{player.pageUrl}":e.dom.isInFrame()?n.referrer:t.location.href,"{playlistinfo.id}":a.playlistinfo?a.playlistinfo.id:"","{playlistinfo.name}":a.playlistinfo?a.playlistinfo.name:"","{timestamp}":(new Date).getTime(),"{document.referrer}":n.referrer,"{window.location.href}":t.location.href,"{random}":Math.floor(1e12*Math.random())}},b=function(e){var t={};return Object.keys(e).forEach(function(n){t["{tcf."+n+"}"]=e[n]}),t["{tcf.gdprAppliesInt}"]=e.gdprApplies?1:0,t},P=function(){return{"{usp.uspString}":y}},k=function(n,a,r){var o=new RegExp("{pageVariable\\.([^}]+)}","g"),i={},s=(n.match(o)||[]).concat(Object.keys(r).filter(function(e){return o.test(e)&&n.includes(r[e])}));if(s)return s.forEach(function(n){for(var r,o=n,s=n.slice(14,-1),d=s.split("."),l=t,u=0;u<d.length;u++)if(u===d.length-1)r=l[d[u]];else if(void 0===(l=l[d[u]]))break;var c=typeof r;null===r?i[o]="null":void 0===r?a[o]?i[o]=a[o]:(e.log.warn('Page variable "'+s+'" not found'),i[o]=""):"string"!==c&&"number"!==c&&"boolean"!==c?(e.log.warn('Page variable "'+s+'" is not a supported type'),i[o]=""):i[o]=r}),i},T=function(t,n,a,r,o){for(var i in void 0===r&&(r={}),n){var s=r.hasOwnProperty(i)?r[i]:i;if(s.startsWith("r:"))try{var d=new RegExp(s.slice(2),"g");t=t.replace(d,m(n[i],a))}catch(t){o.ads.error({errorType:e.Error.AdsMacroReplacementFailed,macro:i,error:t}),e.log.warn('Unable to replace macro with regex "'+s+'". The provided regex may be invalid.')}else t=t.split(s).join(m(n[i],a))}return t};var C={processMetadataTracks:function(e,t){for(var n=e.textTracks(),a=function(n){"metadata"===n.kind&&(e.ads.cueTextTracks.setMetadataTrackMode(n),t(e,n))},r=0;r<n.length;r++)a(n[r]);n.addEventListener("addtrack",function(e){a(e.track)})},setMetadataTrackMode:function(e){},getSupportedAdCue:function(e,t){return t},isSupportedAdCue:function(e,t){return!0},getCueId:function(e,t){return t.id}},R=function(e,t){return void 0!==t&&e.ads.includedCues[t]},w=function(e,t){void 0!==t&&""!==t&&(e.ads.includedCues[t]=!0)};function B(){!1!==this.ads._shouldBlockPlay&&(this.paused()||(this.ads.debug("Playback was canceled by cancelContentPlay"),this.pause()),this.ads._cancelledPlay=!0)}C.processAdTrack=function(t,n,a,r){t.ads.includedCues={};for(var o=0;o<n.length;o++){var i=n[o],s=this.getSupportedAdCue(t,i);if(!this.isSupportedAdCue(t,i))return void e.log.warn("Skipping as this is not a supported ad cue.",i);var d=this.getCueId(t,i),l=i.startTime;if(R(t,d))return void e.log("Skipping ad already seen with ID "+d);r&&r(t,s,d,l),a(t,s,d,l),w(t,d)}};var M={},L=e;M.isMiddlewareMediatorSupported=function(){return!L.browser.IS_IOS&&!L.browser.IS_ANDROID&&!!(L.use&&L.middleware&&L.middleware.TERMINATOR)},M.playMiddleware=function(t){return{setSource:function(e,t){t(null,e)},callPlay:function(){if(t.ads&&!0===t.ads._shouldBlockPlay)return t.ads.debug("Using playMiddleware to block content playback"),t.ads._playBlocked=!0,L.middleware.TERMINATOR},play:function(n,a){t.ads&&t.ads._playBlocked&&n?(t.ads.debug("Play call to Tech was terminated."),t.trigger("play"),t.addClass("vjs-has-started"),t.ads._playBlocked=!1):a&&a.catch&&a.catch(function(n){"NotAllowedError"!==n.name||e.browser.IS_SAFARI||t.trigger("pause")})}}},M.testHook=function(e){L=e};var E=M.playMiddleware,j=M.isMiddlewareMediatorSupported,I=function(){if(e.getPlugin)return Boolean(e.getPlugin("ads"));var t=e.getComponent("Player");return Boolean(t&&t.prototype.ads)};var N=function(){function e(){}return e.getState=function(t){if(t)return e.states_&&e.states_[t]?e.states_[t]:void 0},e.registerState=function(t,n){if("string"!=typeof t||!t)throw new Error('Illegal state name, "'+t+'"; must be a non-empty string.');return e.states_||(e.states_={}),e.states_[t]=n,n},e}(),O=function(){function t(e){this.player=e}t._getName=function(){return"Anonymous State"};var n=t.prototype;return n.transitionTo=function(e){var t=this.player;this.cleanup(t);var n=new e(t);t.ads._state=n,t.ads.debug(this.constructor._getName()+" -> "+n.constructor._getName());for(var a=arguments.length,r=new Array(a>1?a-1:0),o=1;o<a;o++)r[o-1]=arguments[o];n.init.apply(n,[t].concat(r))},n.init=function(){},n.cleanup=function(){},n.onPlay=function(){},n.onPlaying=function(){},n.onEnded=function(){},n.onAdEnded=function(){},n.onAdsReady=function(){e.log.warn("Unexpected adsready event")},n.onAdsError=function(){},n.onAdsCanceled=function(){},n.onAdTimeout=function(){},n.onAdStarted=function(){},n.onAdSkipped=function(){},n.onContentChanged=function(){},n.onContentResumed=function(){},n.onReadyForPostroll=function(){e.log.warn("Unexpected readyforpostroll event")},n.onNoPreroll=function(){},n.onNoPostroll=function(){},n.startLinearAdMode=function(){e.log.warn("Unexpected startLinearAdMode invocation (State via "+this.constructor._getName()+")")},n.endLinearAdMode=function(){e.log.warn("Unexpected endLinearAdMode invocation (State via "+this.constructor._getName()+")")},n.skipLinearAdMode=function(){e.log.warn("Unexpected skipLinearAdMode invocation (State via "+this.constructor._getName()+")")},n.isAdState=function(){throw new Error("isAdState unimplemented for "+this.constructor._getName())},n.isWaitingForAdBreak=function(){return!1},n.isContentResuming=function(){return!1},n.inAdBreak=function(){return!1},n.handleEvent=function(e){var t=this.player;"play"===e?this.onPlay(t):"adsready"===e?this.onAdsReady(t):"adserror"===e?this.onAdsError(t):"adscanceled"===e?this.onAdsCanceled(t):"adtimeout"===e?this.onAdTimeout(t):"ads-ad-started"===e?this.onAdStarted(t):"ads-ad-skipped"===e?this.onAdSkipped(t):"contentchanged"===e?this.onContentChanged(t):"contentresumed"===e?this.onContentResumed(t):"readyforpostroll"===e?this.onReadyForPostroll(t):"playing"===e?this.onPlaying(t):"ended"===e?this.onEnded(t):"nopreroll"===e?this.onNoPreroll(t):"nopostroll"===e?this.onNoPostroll(t):"adended"===e&&this.onAdEnded(t)},t}();N.registerState("State",O);var x=function(e){function t(t){var n;return(n=e.call(this,t)||this).contentResuming=!1,n.waitingForAdBreak=!1,n}p(t,e);var n=t.prototype;return n.isAdState=function(){return!0},n.onPlaying=function(){var e=N.getState("ContentPlayback");this.contentResuming&&this.transitionTo(e)},n.onContentResumed=function(){var e=N.getState("ContentPlayback");this.contentResuming&&this.transitionTo(e)},n.isWaitingForAdBreak=function(){return this.waitingForAdBreak},n.isContentResuming=function(){return this.contentResuming},n.inAdBreak=function(){return!0===this.player.ads._inLinearAdMode},t}(O);N.registerState("AdState",x);var D=function(e){function t(){return e.apply(this,arguments)||this}p(t,e);var n=t.prototype;return n.isAdState=function(){return!1},n.onContentChanged=function(e){var t=N.getState("BeforePreroll"),n=N.getState("Preroll");e.ads.debug("Received contentchanged event (ContentState)"),e.paused()?this.transitionTo(t):(this.transitionTo(n,!1),e.pause(),e.ads._pausedOnContentupdate=!0)},t}(O);N.registerState("ContentState",D);var F,U=function(t){function n(){return t.apply(this,arguments)||this}p(n,t),n._getName=function(){return"AdsDone"};var a=n.prototype;return a.init=function(e){e.ads._contentHasEnded=!0,e.trigger("ended")},a.startLinearAdMode=function(){e.log.warn("Unexpected startLinearAdMode invocation (AdsDone)")},n}(N.getState("ContentState"));N.registerState("AdsDone",U);var V={start:function(t){t.ads.debug("Starting ad break"),t.ads._inLinearAdMode=!0,t.trigger("adstart"),t.ads.shouldTakeSnapshots()&&(t.ads.snapshot=function(t){var n;n=e.browser.IS_IOS&&t.ads.isLive(t)&&t.seekable().length>0?t.currentTime()-t.seekable().end(0):t.currentTime();var a=t.$(".vjs-tech"),r=t.textTracks?t.textTracks():[],o=[],i={ended:t.ended(),currentSrc:t.currentSrc(),sources:t.currentSources(),src:t.tech_.src(),currentTime:n,type:t.currentType()};a&&(i.style=a.getAttribute("style"));for(var s=0;s<r.length;s++){var d=r[s];o.push({track:d,mode:d.mode}),d.mode="disabled"}return i.suppressedTracks=o,i}(t)),t.ads.shouldPlayContentBehindAd(t)&&!t.ads.settings.stitchedAds&&(t.ads.preAdVolume_=t.volume(),t.volume(0)),t.addClass("vjs-ad-playing"),t.hasClass("vjs-live")&&t.removeClass("vjs-live"),t.ads.removeNativePoster(),t.ads.preAdPlaybackRate_=t.playbackRate(),t.playbackRate(1),t.controlBar&&t.controlBar.playbackRateMenuButton&&t.controlBar.playbackRateMenuButton.playbackRateSupported&&!t.controlBar.playbackRateMenuButton.hasClass("vjs-hidden")?(t.controlBar.playbackRateMenuButton.hide(),t.ads.showPlaybackMenuOnAdEnd_=!0):t.ads.showPlaybackMenuOnAdEnd_=!1},end:function(t,n){t.ads.debug("Ending ad break"),void 0===n&&(n=function(){}),t.ads.adType=null,t.ads._inLinearAdMode=!1,t.trigger("adend"),t.removeClass("vjs-ad-playing"),t.ads.isLive(t)&&t.addClass("vjs-live"),t.ads.shouldTakeSnapshots()?function(t,n){var a=t.ads.snapshot;if(void 0===n&&(n=function(){}),!0===t.ads.disableNextSnapshotRestore)return t.ads.disableNextSnapshotRestore=!1,delete t.ads.snapshot,void n();var r,o=t.$(".vjs-tech"),i=20,s=a.suppressedTracks,d=function(){for(var e=0;e<s.length;e++)(r=s[e]).track.mode=r.mode},l=function(){var n;if(e.browser.IS_IOS&&t.ads.isLive(t)){if(a.currentTime<0&&(n=t.seekable().length>0?t.seekable().end(0)+a.currentTime:t.currentTime(),t.currentTime(n)),t.paused()){var r=t.play();r&&r.catch&&r.catch(function(t){e.log.warn("Play promise rejected in IOS snapshot resume",t)})}}else if(a.ended)t.currentTime(t.duration());else{t.currentTime(a.currentTime);var o=t.play();o&&o.catch&&o.catch(function(t){e.log.warn("Play promise rejected in snapshot resume",t)})}t.ads.shouldRemoveAutoplay_&&(t.autoplay(!1),t.ads.shouldRemoveAutoplay_=!1)},u=function n(){if(t.off("contentcanplay",n),F&&t.clearTimeout(F),(o=t.el().querySelector(".vjs-tech")).readyState>1)return l();if(void 0===o.seekable)return l();if(o.seekable.length>0)return l();if(i--)t.setTimeout(n,50);else try{l()}catch(n){t.ads.error({errorType:e.Error.AdsResumeContentFailed,error:n}),e.log.warn("Failed to resume the content after an advertisement",n)}};if("style"in a&&o.setAttribute("style",a.style||""),t.ads.videoElementRecycled())t.one("resumeended",function(){delete t.ads.snapshot,n()}),t.one("contentloadedmetadata",d),e.browser.IS_IOS&&!t.autoplay()&&"function"==typeof t.techCall_&&(t.techCall_("setAutoplay",!0),t.ads.shouldRemoveAutoplay_=!0),t.src(a.sources),t.one("contentcanplay",u),F=t.setTimeout(u,2e3);else{if(d(),!t.ended()){var c=t.play();c&&c.catch&&c.catch(function(t){e.log.warn("Play promise rejected in snapshot restore",t)})}delete t.ads.snapshot,n()}}(t,n):(t.ads.preAdVolume_&&t.volume(t.ads.preAdVolume_),n()),t.playbackRate(t.ads.preAdPlaybackRate_),t.ads.showPlaybackMenuOnAdEnd_&&t.controlBar.playbackRateMenuButton.show()}},q=function(t){function n(){return t.apply(this,arguments)||this}p(n,t),n._getName=function(){return"Preroll"};var a=n.prototype;return a.init=function(e,t,n){if(this.waitingForAdBreak=!0,e.addClass("vjs-ad-loading"),n||e.ads.nopreroll_)return this.resumeAfterNoPreroll(e);var a=e.ads.settings.timeout;"number"==typeof e.ads.settings.prerollTimeout&&(a=e.ads.settings.prerollTimeout),this._timeout=e.setTimeout(function(){e.trigger("adtimeout")},a),t?this.handleAdsReady():this.adsReady=!1},a.onAdsReady=function(t){t.ads.inAdBreak()?e.log.warn("Unexpected adsready event (Preroll)"):(t.ads.debug("Received adsready event (Preroll)"),this.handleAdsReady())},a.handleAdsReady=function(){this.adsReady=!0,this.readyForPreroll()},a.afterLoadStart=function(e){var t=this.player;t.ads._hasThereBeenALoadStartDuringPlayerLife?e():(t.ads.debug("Waiting for loadstart..."),t.one("loadstart",function(){t.ads.debug("Received loadstart event"),e()}))},a.noPreroll=function(){var e=this;this.afterLoadStart(function(){e.player.ads.debug("Skipping prerolls due to nopreroll event (Preroll)"),e.resumeAfterNoPreroll(e.player)})},a.readyForPreroll=function(){var e=this.player;this.afterLoadStart(function(){e.ads.debug("Triggered readyforpreroll event (Preroll)"),e.trigger("readyforpreroll")})},a.onAdsCanceled=function(e){var t=this;e.ads.debug("adscanceled (Preroll)"),this.afterLoadStart(function(){t.resumeAfterNoPreroll(e)})},a.onAdsError=function(t){var n=this;e.log("adserror (Preroll)"),t.ads.error({errorType:e.Error.AdsPrerollError}),this.inAdBreak()?t.ads.endLinearAdMode():this.afterLoadStart(function(){n.resumeAfterNoPreroll(t)})},a.startLinearAdMode=function(){var t=this.player;!this.adsReady||t.ads.inAdBreak()||this.isContentResuming()?e.log.warn("Unexpected startLinearAdMode invocation (Preroll)"):(this.clearTimeout(t),t.ads.adType="preroll",this.waitingForAdBreak=!1,V.start(t),t.ads._shouldBlockPlay=!1)},a.onAdStarted=function(e){e.removeClass("vjs-ad-loading")},a.endLinearAdMode=function(){var e=this.player;this.inAdBreak()&&(e.removeClass("vjs-ad-loading"),e.addClass("vjs-ad-content-resuming"),this.contentResuming=!0,V.end(e))},a.skipLinearAdMode=function(){var t=this,n=this.player;n.ads.inAdBreak()||this.isContentResuming()?e.log.warn("Unexpected skipLinearAdMode invocation"):this.afterLoadStart(function(){n.trigger("adskip"),n.ads.debug("skipLinearAdMode (Preroll)"),t.resumeAfterNoPreroll(n)})},a.onAdTimeout=function(e){var t=this;this.afterLoadStart(function(){e.ads.debug("adtimeout (Preroll)"),t.resumeAfterNoPreroll(e)})},a.onNoPreroll=function(t){t.ads.inAdBreak()||this.isContentResuming()?e.log.warn("Unexpected nopreroll event (Preroll)"):this.noPreroll()},a.resumeAfterNoPreroll=function(e){if(this.contentResuming=!0,e.ads._shouldBlockPlay=!1,this.cleanupPartial(e),e.ads._playRequested||e.ads._pausedOnContentupdate)if(e.paused()){e.ads.debug("resumeAfterNoPreroll: attempting to resume playback (Preroll)");var t=e.play();t&&t.then&&t.then(null,function(e){})}else e.ads.debug("resumeAfterNoPreroll: already playing (Preroll)"),e.trigger("play"),e.trigger("playing")},a.cleanup=function(t){t.ads._hasThereBeenALoadStartDuringPlayerLife||e.log.warn("Leaving Preroll state before loadstart event can cause issues."),this.cleanupPartial(t)},a.cleanupPartial=function(e){e.removeClass("vjs-ad-loading"),e.removeClass("vjs-ad-content-resuming"),this.clearTimeout(e)},a.clearTimeout=function(e){e.clearTimeout(this._timeout),this._timeout=null},n}(N.getState("AdState"));N.registerState("Preroll",q);var H=function(t){function n(){return t.apply(this,arguments)||this}p(n,t),n._getName=function(){return"BeforePreroll"};var a=n.prototype;return a.init=function(e){this.adsReady=!1,this.shouldResumeToContent=!1,e.ads._shouldBlockPlay=!e.ads.settings.allowVjsAutoplay||!e.autoplay()},a.onAdsReady=function(e){e.ads.debug("Received adsready event (BeforePreroll)"),this.adsReady=!0},a.onPlay=function(e){var t=N.getState("Preroll");e.ads.debug("Received play event (BeforePreroll)"),this.transitionTo(t,this.adsReady,this.shouldResumeToContent)},a.onAdsCanceled=function(e){e.ads.debug("adscanceled (BeforePreroll)"),this.shouldResumeToContent=!0},a.onAdsError=function(){this.player.ads.debug("adserror (BeforePreroll)"),this.player.ads.error({errorType:e.Error.BeforePrerollError}),this.shouldResumeToContent=!0},a.onNoPreroll=function(){this.player.ads.debug("Skipping prerolls due to nopreroll event (BeforePreroll)"),this.shouldResumeToContent=!0},a.skipLinearAdMode=function(){var e=this.player;e.trigger("adskip"),e.ads.debug("skipLinearAdMode (BeforePreroll)"),this.shouldResumeToContent=!0},a.onContentChanged=function(){this.init(this.player)},n}(N.getState("ContentState"));N.registerState("BeforePreroll",H);var W=function(t){function n(){return t.apply(this,arguments)||this}p(n,t),n._getName=function(){return"Midroll"};var a=n.prototype;return a.init=function(e){e.ads.adType="midroll",V.start(e),e.addClass("vjs-ad-loading")},a.onAdStarted=function(e){e.removeClass("vjs-ad-loading")},a.endLinearAdMode=function(){var e=this.player;this.inAdBreak()&&(this.contentResuming=!0,e.addClass("vjs-ad-content-resuming"),e.removeClass("vjs-ad-loading"),V.end(e))},a.onAdsError=function(t){t.ads.error({errorType:e.Error.AdsMidrollError}),this.inAdBreak()&&t.ads.endLinearAdMode()},a.cleanup=function(e){e.removeClass("vjs-ad-loading"),e.removeClass("vjs-ad-content-resuming")},n}(N.getState("AdState"));N.registerState("Midroll",W);var z=function(t){function n(){return t.apply(this,arguments)||this}p(n,t),n._getName=function(){return"Postroll"};var a=n.prototype;return a.init=function(e){if(this.waitingForAdBreak=!0,e.ads._contentEnding=!0,e.ads.nopostroll_){this.resumeContent(e);var t=N.getState("AdsDone");this.transitionTo(t)}else{e.addClass("vjs-ad-loading");var n=e.ads.settings.timeout;"number"==typeof e.ads.settings.postrollTimeout&&(n=e.ads.settings.postrollTimeout),this._postrollTimeout=e.setTimeout(function(){e.trigger("adtimeout")},n)}},a.startLinearAdMode=function(){var t=this.player;t.ads.inAdBreak()||this.isContentResuming()?e.log.warn("Unexpected startLinearAdMode invocation (Postroll)"):(t.ads.adType="postroll",t.clearTimeout(this._postrollTimeout),this.waitingForAdBreak=!1,V.start(t))},a.onAdStarted=function(e){e.removeClass("vjs-ad-loading")},a.endLinearAdMode=function(){var e=this,t=this.player,n=N.getState("AdsDone");this.inAdBreak()&&(t.removeClass("vjs-ad-loading"),this.resumeContent(t),V.end(t,function(){e.transitionTo(n)}))},a.skipLinearAdMode=function(){var t=this.player;t.ads.inAdBreak()||this.isContentResuming()?e.log.warn("Unexpected skipLinearAdMode invocation"):(t.ads.debug("Postroll abort (skipLinearAdMode)"),t.trigger("adskip"),this.abort(t))},a.onAdTimeout=function(e){e.ads.debug("Postroll abort (adtimeout)"),this.abort(e)},a.onAdsError=function(t){t.ads.debug("Postroll abort (adserror)"),t.ads.error({errorType:e.Error.AdsPostrollError}),t.ads.inAdBreak()?t.ads.endLinearAdMode():this.abort(t)},a.onContentChanged=function(e){if(this.isContentResuming()){var t=N.getState("BeforePreroll");this.transitionTo(t)}else if(!this.inAdBreak()){var n=N.getState("Preroll");this.transitionTo(n)}},a.onNoPostroll=function(t){this.isContentResuming()||this.inAdBreak()?e.log.warn("Unexpected nopostroll event (Postroll)"):this.abort(t)},a.resumeContent=function(e){this.contentResuming=!0,e.addClass("vjs-ad-content-resuming")},a.abort=function(e){var t=N.getState("AdsDone");this.resumeContent(e),e.removeClass("vjs-ad-loading"),this.transitionTo(t)},a.cleanup=function(e){e.removeClass("vjs-ad-content-resuming"),e.clearTimeout(this._postrollTimeout),e.ads._contentEnding=!1},n}(N.getState("AdState"));N.registerState("Postroll",z);var $=function(e){function t(){return e.apply(this,arguments)||this}p(t,e),t._getName=function(){return"ContentPlayback"};var n=t.prototype;return n.init=function(e){e.ads._shouldBlockPlay=!1},n.onAdsReady=function(e){e.ads.debug("Received adsready event (ContentPlayback)"),e.ads.nopreroll_||(e.ads.debug("Triggered readyforpreroll event (ContentPlayback)"),e.trigger("readyforpreroll"))},n.onReadyForPostroll=function(e){var t=N.getState("Postroll");e.ads.debug("Received readyforpostroll event"),this.transitionTo(t)},n.startLinearAdMode=function(){var e=N.getState("Midroll");this.transitionTo(e)},t}(N.getState("ContentState"));N.registerState("ContentPlayback",$);var J=function(e){function t(){return e.apply(this,arguments)||this}p(t,e),t._getName=function(){return"StitchedContentPlayback"};var n=t.prototype;return n.init=function(){this.player.ads._shouldBlockPlay=!1},n.onContentChanged=function(){this.player.ads.debug("Received contentchanged event ("+this.constructor._getName()+")")},n.startLinearAdMode=function(){var e=N.getState("StitchedAdRoll");this.transitionTo(e)},t}(N.getState("ContentState"));N.registerState("StitchedContentPlayback",J);var Y=function(e){function t(){return e.apply(this,arguments)||this}p(t,e),t._getName=function(){return"StitchedAdRoll"};var n=t.prototype;return n.init=function(){this.waitingForAdBreak=!1,this.contentResuming=!1,this.player.ads.adType="stitched",V.start(this.player)},n.onPlaying=function(){},n.onContentResumed=function(){},n.onAdEnded=function(){this.endLinearAdMode(),this.player.trigger("ended")},n.endLinearAdMode=function(){var e=N.getState("StitchedContentPlayback");V.end(this.player),this.transitionTo(e)},t}(N.getState("AdState"));N.registerState("StitchedAdRoll",Y);var G=M.isMiddlewareMediatorSupported,K=e.getTech("Html5").Events,Q={timeout:5e3,prerollTimeout:void 0,postrollTimeout:void 0,debug:!1,stitchedAds:!1,contentIsLive:void 0,liveCuePoints:!0,allowVjsAutoplay:e.options.normalizeAutoplay||!1},X=function(t){var n=this;try{var r=e.obj.merge(Q,t)}catch(n){r=e.mergeOptions(Q,t)}var o=[];K.concat(["firstplay","loadedalldata"]).forEach(function(e){-1===o.indexOf(e)&&o.push(e)}),n.on(o,u),G()||function(t,n){n&&e.log("Using cancelContentPlay to block content playback"),t.on("play",B)}(n,r.debug),n.setTimeout(function(){n.ads._hasThereBeenALoadStartDuringPlayerLife||""===n.src()||e.log.error("videojs-contrib-ads has not seen a loadstart event 5 seconds after being initialized, but a source is present. This indicates that videojs-contrib-ads was initialized too late. It must be initialized immediately after video.js in the same tick. As a result, some ads will not play and some media events will be incorrect. For more information, see http://videojs.github.io/videojs-contrib-ads/integrator/getting-started.html")},5e3),n.on("ended",function(){n.hasClass("vjs-has-started")||n.addClass("vjs-has-started")}),n.on("contenttimeupdate",function(){n.removeClass("vjs-waiting")}),n.on(["addurationchange","adcanplay"],function(){if(!n.ads.settings.stitchedAds&&!n.hasStarted()&&(!n.ads.snapshot||n.currentSrc()!==n.ads.snapshot.currentSrc)&&n.ads.inAdBreak()){var t=n.play();t&&t.catch&&t.catch(function(t){e.log.warn("Play promise rejected when playing ad",t)})}}),n.on("nopreroll",function(){n.ads.debug("Received nopreroll event"),n.ads.nopreroll_=!0}),n.on("nopostroll",function(){n.ads.debug("Received nopostroll event"),n.ads.nopostroll_=!0}),n.on("playing",function(){n.ads._cancelledPlay=!1,n.ads._pausedOnContentupdate=!1}),n.on("play",function(){n.ads._playRequested=!0}),n.one("loadstart",function(){n.ads._hasThereBeenALoadStartDuringPlayerLife=!0}),n.on("loadeddata",function(){n.ads._hasThereBeenALoadedData=!0}),n.on("loadedmetadata",function(){n.ads._hasThereBeenALoadedMetaData=!0}),n.ads=function(t){return{disableNextSnapshotRestore:!1,_contentEnding:!1,_contentHasEnded:!1,_hasThereBeenALoadStartDuringPlayerLife:!1,_hasThereBeenALoadedData:!1,_hasThereBeenALoadedMetaData:!1,_inLinearAdMode:!1,_shouldBlockPlay:!1,_playBlocked:!1,_playRequested:!1,_error:null,adType:null,VERSION:a,reset:function(){t.ads.disableNextSnapshotRestore=!1,t.ads._contentEnding=!1,t.ads._contentHasEnded=!1,t.ads.snapshot=null,t.ads.adType=null,t.ads._hasThereBeenALoadedData=!1,t.ads._hasThereBeenALoadedMetaData=!1,t.ads._cancelledPlay=!1,t.ads._shouldBlockPlay=!1,t.ads._playBlocked=!1,t.ads.nopreroll_=!1,t.ads.nopostroll_=!1,t.ads._playRequested=!1,t.ads._error=null},startLinearAdMode:function(){t.ads._state.startLinearAdMode()},endLinearAdMode:function(){t.ads._state.endLinearAdMode()},skipLinearAdMode:function(){t.ads._state.skipLinearAdMode()},stitchedAds:function(t){return void 0!==t&&(e.log.warn("Using player.ads.stitchedAds() as a setter is deprecated, it should be set as an option upon initialization of contrib-ads."),this.settings.stitchedAds=!!t),this.settings.stitchedAds},videoElementRecycled:function(){if(t.ads.shouldPlayContentBehindAd(t))return!1;if(!this.snapshot)throw new Error("You cannot use videoElementRecycled while there is no snapshot.");var e=t.tech_.src()!==this.snapshot.src,n=t.currentSrc()!==this.snapshot.currentSrc;return e||n},isLive:function(n){return void 0===n&&(n=t),"boolean"==typeof n.ads.settings.contentIsLive?n.ads.settings.contentIsLive:n.duration()===1/0||"8"===e.browser.IOS_VERSION&&0===n.duration()},shouldPlayContentBehindAd:function(n){if(void 0===n&&(n=t),n)return!!n.ads.settings.liveCuePoints&&!e.browser.IS_IOS&&!e.browser.IS_ANDROID&&n.duration()===1/0;throw new Error("shouldPlayContentBehindAd requires a player as a param")},shouldTakeSnapshots:function(e){return void 0===e&&(e=t),!this.shouldPlayContentBehindAd(e)&&!this.stitchedAds()},isInAdMode:function(){return this._state.isAdState()},isWaitingForAdBreak:function(){return this._state.isWaitingForAdBreak()},isContentResuming:function(){return this._state.isContentResuming()},isAdPlaying:function(){return this._state.inAdBreak()},inAdBreak:function(){return this._state.inAdBreak()},removeNativePoster:function(){var e=t.$(".vjs-tech");e&&e.removeAttribute("poster")},debug:function(){if(this.settings.debug){for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];1===n.length&&"string"==typeof n[0]?e.log("ADS: "+n[0]):e.log.apply(e,["ADS:"].concat(n))}},error:function(n){if(void 0===n)return this._error||null;null!==n&&n.errorType?(this._error=n,e.log.error("An error with Ads occured. Type: "+n.errorType+"."),t.trigger({type:"vjsadserror",error:this._error})):this._error=null}}}(n),n.ads.settings=r,r.stitchedAds=!!r.stitchedAds,r.stitchedAds?n.ads._state=new(N.getState("StitchedContentPlayback"))(n):n.ads._state=new(N.getState("BeforePreroll"))(n),n.ads._state.init(n),n.ads.cueTextTracks=C,n.ads.adMacroReplacement=function(e,t,n){void 0===t&&(t=!1),void 0===n&&(n={});var a=n.disableDefaultMacros||!1,r=n.macroNameOverrides||{};delete n.disableDefaultMacros,delete n.macroNameOverrides;var o=n;if(a)return T(e,o,t,r);var i=_(e),s=i.defaults,d=i.modifiedString;for(var l in e=d,c(o,S(this),A(this.mediainfo,s),b(h),P(),k(e,s,r)),e=T(e,o,t,r,this),s)e=e.replace(l,s[l]);return e}.bind(n),function(e){e.ads.contentSrc=e.currentSrc(),e.ads._seenInitialLoadstart=!1,e.on("loadstart",function(){if(!e.ads.inAdBreak()){var t=e.currentSrc();t!==e.ads.contentSrc&&(e.ads._seenInitialLoadstart&&e.trigger({type:"contentchanged"}),e.trigger({type:"contentupdate",oldValue:e.ads.contentSrc,newValue:t}),e.ads.contentSrc=t),e.ads._seenInitialLoadstart=!0}})}(n),n.on("contentchanged",n.ads.reset);var i=function(){var t=n.textTracks();if(!n.ads.shouldPlayContentBehindAd(n)&&n.ads.inAdBreak()&&n.tech_.featuresNativeTextTracks&&e.browser.IS_IOS&&!Array.isArray(n.textTracks()))for(var a=0;a<t.length;a++){var r=t[a];"showing"===r.mode&&(r.mode="disabled")}};n.ready(function(){n.textTracks().addEventListener("change",i)}),n.on(["play","playing","ended","adsready","adscanceled","adskip","adserror","adtimeout","adended","ads-ad-started","ads-ad-skipped","contentchanged","dispose","contentresumed","readyforpostroll","nopreroll","nopostroll"],function(e){n.ads._state.handleEvent(e.type)}),n.on("dispose",function(){n.ads.reset(),n.textTracks().removeEventListener("change",i)}),g(),v(function(){}),n.ads.listenToTcf=g,n.ads.updateUsPrivacyString=function(e){return v(e)}};return X.VERSION=a,function(t){!I(e)&&((e.registerPlugin||e.plugin)("ads",t),j()&&!e.usingContribAdsMiddleware_&&(e.use("*",E),e.usingContribAdsMiddleware_=!0,e.log.debug("Play middleware has been registered with videojs")))}(X),X});
